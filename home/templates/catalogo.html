{% extends "base.html" %}
{% block breadcrumbs %}
    </li>
    
    <li>
        <span class="text-lg text-gray-500">></span>
        <span class="text- font-medium text-gray-500 hover:text-[#bf7149]">
            {{ categoria_actual }}
        </span>
    </li>
{% endblock breadcrumbs %}

{% block content %}
{% load static %}
<main class="py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">
            {{ categoria_actual }}      
        </h1>
        
        <hr class="mb-8">

        {% if productos_destacados %}
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 xl:gap-8">
                
                {% for producto in productos_destacados %}
                
                    <a href="{% url 'detalle_producto' pk=producto.pk %}" 
                       class="block bg-white rounded-lg p-3 flex flex-col items-center justify-between transition duration-300 ease-in-out transform hover:shadow-hard-halo hover:scale-[1.02]">
                        
                        <div>
                           {% if producto.imagen %}
    <div class="relative w-full h-32 mb-4 flex justify-center items-center">
        <img src="{{ producto.imagen.url }}" alt="Imagen de {{ producto.nombre }}" 
             class="max-h-full max-w-full object-contain mix-blend-multiply">
        
        {% if producto.stock <= 0 %}
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <span class="bg-red-500 text-white text-base font-bold text-center uppercase tracking-wider py-1 px-4 transform -rotate-45 whitespace-nowrap">
                AGOTADO
            </span>
        </div>
        {% endif %}
    </div>
{% else %}
<div class="relative w-full h-32 mb-4 flex justify-center items-center">
        <img src="{% static 'imagen1.jpg' %}" alt="Imagen por defecto"
             class="max-h-full max-w-full object-contain mix-blend-multiply">
                                    
        
        {% if producto.stock <= 0 %}
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <span class="bg-red-500 text-white text-base font-bold text-center uppercase tracking-wider py-1 px-4 transform -rotate-45 whitespace-nowrap">
                AGOTADO
            </span>
        </div>
        {% endif %}
    </div>
{% endif %}
                        </div>

                        <div class="w-full text-center flex-grow flex flex-col justify-end">
                            
                            <h4 class="text-sm font-bold uppercase text-gray-900 leading-tight mb-1 line-clamp-2">
                                {{ producto.nombre|upper }}
                            </h4>
                            
                            <p class="text-xs text-gray-500 mb-2">
                                Fabricante: {{ producto.fabricante }}
                            </p>
                            
                            <div class="mb-3">
                                {% if producto.stock > 0 %}
                                    <span class="text-sm font-semibold text-[#6a760c]">
                                        {{ producto.stock }} unidades de inventario
                                    </span>
                                {% else %}
                                    <span class="text-sm font-semibold text-red-600">
                                        Sin productos
                                    </span>
                                {% endif %}
                            </div>
                            
                            <span class="text-4xl font-bold mb-4 text-[#A91B0D]">
                            {{ producto.euros }},<span class="text-2xl">{{ producto.centavos|stringformat:"02d" }}€</span>
                            </span>
                        </div>
                        
                        {% if not user.is_authenticated or not user.is_staff %}
                        {% if producto.stock > 0 %}
                        <form class="add-to-cart-form" data-product-id="{{ producto.id }}">
                            {% csrf_token %}
                            <button type="submit" 
                                class="px-4 mb-4 py-1 bg-[#bf7149] text-white font-semibold rounded-lg 
                                    hover:bg-yellow-600 transition duration-300">
                                Añadir a la Cesta
                            </button>
                        </form>
                        {% endif %}
                         {% endif %}
                    </a>
                    {% endfor %}
                
            </div>
        {% else %}
            <div class="p-6 bg-[#f9fdf2] border-l-4 border-[#bf7149] text-[#bf7149] rounded-lg">
                <p class="font-semibold">¡Lo sentimos!</p>
                <p>Actualmente no hay productos disponibles.</p>
            </div>
        {% endif %}

    </div>

    {% if messages %}
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 space-y-2">
        {% for message in messages %}
        <div class="toast {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <style>
    .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: #16a34a; /* verde éxito */
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    </style>

</main>
{% endblock content %}

{% block extra_css %}
<style>
    /* ... (Estilos existentes) ... */
    .hover\:shadow-hard-halo:hover {
        box-shadow: 0 0 15px rgba(39, 43, 4, 0.4); 
    }
    .lm-text-green { 
        color: #6a760c; 
    }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
    {{ block.super }} 

    <script>
        document.querySelectorAll('.add-to-cart-form').forEach(form => {
            form.addEventListener('submit', function(e){
                e.preventDefault();

                const productId = this.dataset.productId;
                const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch(`/cesta/agregar/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({cantidad: 1})
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        showToast(data.mensaje);

                        const badge = document.querySelector('#cesta-badge');
                        if(badge){
                            badge.textContent = data.total_items;
                        } else {
                            const cestaLink = document.querySelector('a[href="{% url "carrito:carrito" %}"]');
                            const span = document.createElement('span');
                            span.id = "cesta-badge";
                            span.className = "absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center";
                            span.textContent = data.total_items;
                            cestaLink.appendChild(span);
                        }
                    }
                });
            });
        });

        function showToast(mensaje){
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = mensaje;
            document.body.appendChild(toast);

            // Forzar reflow para que se active la transición
            void toast.offsetWidth;

            // Mostrar suavemente
            toast.classList.add('show');

            // Ocultar después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show'); // inicia transición de desaparición
                setTimeout(() => toast.remove(), 500); // eliminar del DOM
            }, 3000);
        }
        </script>
{% endblock extra_js %}