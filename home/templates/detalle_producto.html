{% extends "base.html" %}

{% block breadcrumbs %}
    <li>
        <span class="text-lg text-gray-500">></span>
        <a href="{% url 'productos_por_categoria' categoria=producto.categoria %}" class="text- font-medium text-gray-500 hover:text-[#bf7149]">
            {{ producto.get_categoria_display|upper }} 
        </a>
    </li>
    <li>
        <span class="text-lg text-gray-500">></span>
        <span class="text- font-medium text-gray-500 hover:text-[#bf7149]">
            {{ producto.nombre|upper }}
        </span>
    </li>
{% endblock breadcrumbs %}

{% block content %}
{% load static %}

<main class="py-10">
    <div class="product-detail-container" style="display: flex; gap: 40px; max-width: 1200px; margin: 0 auto; padding: 20px;">
        
        <div class="product-image-area relative flex flex-col justify-center items-center bg-gray-50 rounded-lg border border-gray-200 overflow-hidden" 
             style="flex: 1; max-width: 50%; min-height: 400px;">
            
            {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" alt="Imagen de {{ producto.nombre }}" class="w-full h-full object-contain" style="max-height: 400px;">
            {% else %}
                <img src="https://res.cloudinary.com/djfgts1ii/image/upload/imagen1_zi2acs.jpg" alt="Imagen por defecto" class="w-full h-full object-contain opacity-60" style="max-height: 400px;">
            {% endif %}

            {% if producto.stock <= 0 %}
            <div class="absolute inset-0 z-10 flex items-center justify-center bg-gray-100 bg-opacity-50 pointer-events-none">
                <span class="bg-red-600 text-white text-2xl font-bold text-center uppercase tracking-widest py-4 px-12 transform -rotate-45 shadow-2xl border-4 border-white">
                    AGOTADO
                </span>
            </div>
            {% endif %}
        </div>

        <div class="product-info-area" style="flex: 1; max-width: 50%;">
            <h1 style="font-size: 2.5em; color: #000; text-transform: uppercase; margin-top: 0; font-weight: bold;">
                {{ producto.nombre }}
            </h1>
            
            <span class="text-4xl font-bold mb-4 text-[#A91B0D] block">
                {{ producto.euros }},<span class="text-2xl">{{ producto.centavos|stringformat:"02d" }}€</span>
            </span>
            
            <p style="font-size: 1em; color: {% if producto.stock > 10 %} green {% else %} orange {% endif %}; margin-bottom: 25px;">
                {% if producto.esta_agotado or producto.stock <= 0 %}
                    <span class="text-red-600 font-bold" id="stock-container-{{ producto.id }}">SIN PRODUCTO</span>
                {% else %}
                    <span id="stock-container-{{ producto.id }}">
                        Productos disponibles: <span id="stock-display-{{ producto.id }}" class="font-bold">{{ producto.stock }}</span> unidades
                    </span>
                {% endif %}
            </p>

            {% if not user.is_authenticated or not user.is_staff %}
                <div class="flex items-center gap-5 mb-10">
                    {% if producto.stock > 0 %}
                        <form class="add-to-cart-form flex items-center gap-3" data-product-id="{{ producto.id }}">
                            {% csrf_token %}
                            <div class="flex border border-gray-300 rounded overflow-hidden">
                                <button type="button" onclick="changeQuantity(this, -1)" class="px-3 py-2 bg-gray-50 hover:bg-gray-100 border-r border-gray-300 transition-colors text-gray-600">-</button>
                                <input type="number" name="cantidad" class="quantity-input w-16 text-center border-none focus:ring-0 focus:outline-none text-gray-700" value="1" min="1" max="{{ producto.stock }}" readonly> 
                                <button type="button" onclick="changeQuantity(this, 1)" class="px-3 py-2 bg-gray-50 hover:bg-gray-100 border-l border-gray-300 transition-colors text-gray-600">+</button>
                            </div>
                            <button type="submit" class="px-6 py-2 bg-[#bf7149] hover:bg-[#a35d3a] text-white font-bold rounded shadow-sm transition duration-150 ease-in-out transform active:scale-95">
                                Añadir a la Cesta
                            </button>
                        </form>
                    {% else %}
                        <span class="px-4 py-2 bg-gray-200 text-gray-500 font-medium rounded cursor-not-allowed">Agotado</span>
                    {% endif %}
                </div>
            {% endif %}

            <div class="info-importante bg-white border border-gray-200 rounded-xl shadow-sm divide-y divide-gray-200 mt-6">
                <div class="flex items-start gap-3 p-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[#6a760c] mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">Entrega en Tienda</h3><span class="text-gray-500">GRATIS</span>
                        <ul class="text-gray-700 text-sm space-y-1 mt-1">
                            <li class="flex items-center gap-2">
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                                Para una unidad, disponibilidad inmediata.
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                                Para más de una unidad, disponible a partir de 2 horas tras hacer el pedido.
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="flex items-start gap-3 p-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[#6a760c] mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v13a2 2 0 01-2 2H5a2 2 0 01-2-2V3zM3 3l9 7 9-7" />
                    </svg>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">Entrega a Domicilio</h3>
                        <ul class="text-gray-700 text-sm space-y-1 mt-1">
                            <li class="flex items-center gap-2">
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                                Entrega de producto en un plazo de 48 horas. Costes variables según el pedido.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="features-dropdown" style="max-width: 1200px; margin: 20px auto; padding: 20px; border: 1px solid #dcdcdc; border-radius: 8px;">
        <details open style="margin-top: 0;"> 
            <summary style="font-size: 1.5em; display: flex; align-items: center; gap: 10px; font-weight: bold; cursor: pointer; padding: 10px 0; list-style: none;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lm-text-black mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                <span class="text-black">Características y Especificaciones</span>       
            </summary>
            <div class="details-content" style="padding: 15px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; margin-top: 10px;">
                <h3 style="font-size: 1.2em; margin-top: 0;">Descripción:</h3>
                <p>{{ producto.descripcion|linebreaksbr }}</p>
                <hr style="margin: 15px 0;">
                <p><strong>Fabricante:</strong> {{ producto.fabricante }}</p>
                {% load text_filters %}
                <p><strong>Categoría:</strong> {{ producto.categoria|espaciar }}</p>
                <p><strong>Sección:</strong> {{ producto.seccion|espaciar }}</p>
                <p><strong>Departamento:</strong> {{ producto.departamento }}</p>
            </div>
        </details>
    </div>

    <div class="related-products-section" style="max-width: 1200px; margin: 40px auto; padding: 20px;">
        <h2 style="font-size: 1.8em; text-align: center; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #ccc; padding-bottom: 5px;">
            Productos de la misma categoría
        </h2>
        {% if productos_relacionados %}
        <div class="carousel-container" style="position: relative;">
            <div id="product-carousel" class="product-list" style="display: flex; overflow-x: hidden; scroll-behavior: smooth; gap: 20px; padding: 40px 0; user-select: none;">
                {% for relacionado in productos_relacionados %}
                <a href="{% url 'detalle_producto' pk=relacionado.pk %}" class="block bg-white rounded-lg p-3 flex flex-col items-center justify-between transition duration-300 ease-in-out transform hover:shadow-hard-halo hover:scale-[1.02]" style="flex: 0 0 calc(20% - 16px);">
                    <div class="relative w-full h-32 mb-4 flex justify-center items-center bg-gray-50 rounded overflow-hidden">
                        {% if relacionado.imagen %}
                            <img src="{{ relacionado.imagen.url }}" alt="Imagen de {{ relacionado.nombre }}" class="max-h-full max-w-full object-contain mix-blend-multiply">
                        {% else %}
                            <img src="https://res.cloudinary.com/djfgts1ii/image/upload/imagen1_zi2acs.jpg" alt="Imagen por defecto" class="max-h-full max-w-full object-contain mix-blend-multiply opacity-50">
                        {% endif %}
                        {% if relacionado.stock <= 0 %}
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                            <span class="bg-red-500 text-white text-xs font-bold uppercase py-1 px-4 transform -rotate-45 shadow-md">AGOTADO</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="w-full text-center flex-grow flex flex-col justify-end">
                        <h4 class="text-sm font-bold uppercase text-gray-900 leading-tight mb-1 line-clamp-2">{{ relacionado.nombre|upper }}</h4>
                        <p class="text-xs text-gray-500 mb-2">Fabricante: {{ relacionado.fabricante }}</p>
                        <div class="mb-3">
                            {% if relacionado.stock > 0 %}
                            <span class="text-sm font-semibold text-[#6a760c]">{{ relacionado.stock }} unidades en el almacén</span>
                            {% else %}
                            <span class="text-sm font-semibold text-red-600">Sin productos</span>
                            {% endif %}
                        </div>
                        <span class="text-4xl font-bold mb-4 text-[#A91B0D]">{{ relacionado.euros }},<span class="text-2xl">{{ relacionado.centavos|stringformat:"02d" }}€</span></span>
                    </div>
                    {% if not user.is_authenticated or not user.is_staff %}
                        {% if relacionado.stock > 0 %}
                            <button onclick="event.preventDefault();" class="add-related w-full py-2 bg-white text-[#bf7149] font-semibold rounded-md border-2 border-[#bf7149] hover:bg-[#bf7149] hover:text-white transition duration-150 relative z-10 mt-2" data-product-id="{{ relacionado.pk }}"> 
                            Añadir a la Cesta
                            </button>
                            {% csrf_token %}
                        {% endif %}
                    {% endif %}
                </a>
                {% endfor %}
            </div>
            <button id="prev-btn" class="absolute top-1/2 left-0 transform -translate-y-1/2 ml-4 w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-hard-halo hover:bg-gray-100 transition z-40"><svg class="h-6 w-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
            <button id="next-btn" class="absolute top-1/2 right-0 transform -translate-y-1/2 mr-4 w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-hard-halo hover:bg-gray-100 transition z-40"><svg class="h-6 w-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
        </div>
        {% else %}
        <div class="text-center text-gray-500 mt-8 mb-12"><p>No hay productos relacionados disponibles.</p></div>
        {% endif %}

        {% if messages %}
        <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 space-y-2">
            {% for message in messages %}
            <div class="toast {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <style>
    .toast {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
        background: #16a34a; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600;
        opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease; z-index: 9999; pointer-events: auto;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .hover\:shadow-hard-halo:hover { box-shadow: 0 0 15px rgba(39, 43, 4, 0.2); }
    </style>

    <script>
        function changeQuantity(button, amount) {
            const quantityControl = button.parentElement;
            const input = quantityControl.querySelector('.quantity-input');
            const min = parseInt(input.min) || 1;
            const max = parseInt(input.max); 
            let newValue = (parseInt(input.value) || 1) + amount;
            if (newValue < min) newValue = min;
            if (!isNaN(max) && newValue > max) newValue = max;
            input.value = newValue;
        }

        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. CARRUSEL
            const carousel = document.getElementById('product-carousel');
            const prevButton = document.getElementById('prev-btn');
            const nextButton = document.getElementById('next-btn');
            
            if(carousel && prevButton && nextButton){ 
                const cardsToScroll = 3; 
                const gapSize = 20;
                let CARD_WIDTH_PLUS_GAP = 260; 
                if (carousel.children.length > 0) CARD_WIDTH_PLUS_GAP = carousel.children[0].offsetWidth + gapSize;
                
                prevButton.addEventListener('click', (e) => { e.preventDefault(); carousel.scrollBy({ left: -(CARD_WIDTH_PLUS_GAP * cardsToScroll), behavior: 'smooth' }); });
                nextButton.addEventListener('click', (e) => { e.preventDefault(); carousel.scrollBy({ left: (CARD_WIDTH_PLUS_GAP * cardsToScroll), behavior: 'smooth' }); });
            }

            // 2. UTILIDADES
            function showToast(mensaje){
                let toastContainer = document.getElementById('toast-container');
                if(!toastContainer){
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 space-y-2 pointer-events-none';
                    document.body.appendChild(toastContainer);
                }
                const toast = document.createElement('div');
                toast.className = 'toast show'; 
                toast.textContent = mensaje;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3000);
            }

            function actualizarBadge(totalItems){
                const badge = document.querySelector('#cesta-badge');
                if(badge){ badge.textContent = totalItems; badge.style.display = totalItems > 0 ? 'flex' : 'none'; }
                else {
                    const cestaLink = document.querySelector('a[href*="/carrito/"]'); 
                    if(cestaLink && totalItems > 0){
                        cestaLink.classList.add('relative'); 
                        const span = document.createElement('span');
                        span.id = "cesta-badge";
                        span.className = "absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center";
                        span.textContent = totalItems;
                        cestaLink.appendChild(span);
                    }
                }
            }

            // 3. AJAX (Añadir al Carrito)
            function agregarAlCarrito(productId, cantidad, csrfToken, formElement = null){
                if (cantidad < 1) { showToast("Selecciona una cantidad válida"); return; }
                const url = `/carrito/update/${productId}/`; 
                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'action': 'add', 'cantidad': cantidad })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        showToast("✅ " + data.mensaje);
                        if(data.total_items !== undefined) actualizarBadge(data.total_items);
                        
                        // Recarga para actualizar stock visualmente
                        setTimeout(() => { window.location.reload(); }, 500);

                    } else {
                        showToast(data.mensaje); // Mensaje limpio
                    }
                })
                .catch(error => { console.error(error); showToast('Error de conexión'); });
            }

            // A) Formularios de la ficha
            document.querySelectorAll('.add-to-cart-form').forEach(form => {
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    const productId = this.dataset.productId;
                    const cantidad = parseInt(this.querySelector('.quantity-input').value) || 0; 
                    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
                    agregarAlCarrito(productId, cantidad, csrfToken, this);
                });
            });

            // B) Botones sueltos (carrusel)
            document.querySelectorAll('.add-related').forEach(btn => {
                btn.addEventListener('click', function(e){
                    e.preventDefault(); e.stopPropagation(); 
                    const productId = this.dataset.productId;
                    const mainToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (mainToken && productId) agregarAlCarrito(productId, 1, mainToken.value, null);
                });
            });

            // 4. POLLING DE STOCK
            function iniciarRevisionStock() {
                setInterval(() => { actualizarStocksEnTiempoReal(); }, 5000); 
            }

            function actualizarStocksEnTiempoReal() {
                // Recolectar IDs visibles
                let ids = new Set();
                
                // Del producto principal
                const mainForm = document.querySelector('.add-to-cart-form');
                if (mainForm && mainForm.dataset.productId) ids.add(mainForm.dataset.productId);

                // Del carrusel
                document.querySelectorAll('.add-related').forEach(btn => {
                    if(btn.dataset.productId) ids.add(btn.dataset.productId);
                });

                if (ids.size === 0) return;

                const idsString = Array.from(ids).join(',');

                fetch(`/api/verificar-stock/?ids=${idsString}`)
                    .then(response => response.json())
                    .then(data => {
                        for (const [productId, stockReal] of Object.entries(data)) {
                            // 1. Actualizar texto
                            const stockSpan = document.getElementById(`stock-display-${productId}`);
                            if(stockSpan) {
                                if (stockReal > 0) {
                                    stockSpan.textContent = stockReal;
                                } else {
                                    const container = document.getElementById(`stock-container-${productId}`);
                                    if(container) container.innerHTML = '<span class="text-red-600 font-bold">SIN PRODUCTO</span>';
                                }
                            }

                            // 2. Deshabilitar botones si se agota
                            const forms = document.querySelectorAll(`.add-to-cart-form[data-product-id="${productId}"]`);
                            forms.forEach(form => {
                                const btn = form.querySelector('button[type="submit"]');
                                const input = form.querySelector('.quantity-input');
                                
                                if (stockReal <= 0) {
                                    if(btn && !btn.disabled) {
                                        btn.disabled = true;
                                        btn.innerText = "Agotado";
                                        btn.classList.remove('bg-[#bf7149]', 'hover:bg-yellow-600', 'text-white');
                                        btn.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                                    }
                                    if(input) input.disabled = true;
                                } else {
                                    // Reponer si vuelve stock
                                    if(btn && btn.disabled) {
                                        btn.disabled = false;
                                        btn.innerText = "Añadir a la Cesta";
                                        btn.classList.add('bg-[#bf7149]', 'hover:bg-yellow-600', 'text-white');
                                        btn.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                                    }
                                    if(input) {
                                        input.disabled = false;
                                        input.max = stockReal;
                                    }
                                }
                            });
                        }
                    })
                    .catch(err => console.error("Error stock:", err));
            }

            iniciarRevisionStock();
        });
    </script>
</main>
{% endblock content %}

{% block extra_css %}
{% endblock extra_css %}