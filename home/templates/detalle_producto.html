{% extends "base.html" %}
{% block breadcrumbs %}

    <li>
    <span class="text-lg text-gray-500">></span>
        <a href="{% url 'productos_por_categoria' categoria=producto.categoria %}" class="text- font-medium text-gray-500 hover:text-[#bf7149]">
                            {{ producto.get_categoria_display|upper }} 
                        </a>
</li>
    <li>
        <span class="text-lg text-gray-500">></span>
        <span class="text- font-medium text-gray-500 hover:text-[#bf7149]">
            {{ producto.nombre|upper }}
        </span>

    </li>
{% endblock breadcrumbs %}

{% block content %}
{% load static %}

<main class="py-10">
    <div class="product-detail-container" style="display: flex; gap: 40px; max-width: 1200px; margin: 0 auto; padding: 20px;">
        {% if producto.imagen %}
        <div class="product-image-area" style="flex: 1; max-width: 50%;">
            
                <img src="{{ producto.imagen.url }}" alt="Imagen de {{ producto.nombre }}" style="width: 100%; height: auto; border: 1px solid #ccc; border-radius: 8px;">
            
            {% if producto.stock <= 0 %}
            <div class="absolute inset-1 flex items-center justify-left pointer-events-none mb-10 mt-40  mr-10">
            <span class="bg-red-500 text-white text-2xl font-bold text-center uppercase tracking-wider py-3 px-10 transform -rotate-45 whitespace-nowrap">
                AGOTADO
            </span>
        </div>
         {% endif %}
                {% else %}
                        <div class="product-image-area" style="flex: 1; max-width: 50%;">

                                <img src="{% static 'imagen1.jpg' %}" alt="Imagen por defecto" style="width: 100%; height: auto; border: 1px solid #ccc; border-radius: 8px;">
{% if producto.stock <= 0 %}
        <div class="absolute inset-1 flex items-center justify-left pointer-events-none mb-10 mt-40  mr-10">
            <span class="bg-red-500 text-white text-2xl font-bold text-center uppercase tracking-wider py-3 px-10 transform -rotate-45 whitespace-nowrap">
                AGOTADO
            </span>
        </div>
        {% endif %}
            {% endif %}

            
        </div>

        <div class="product-info-area" style="flex: 1; max-width: 50%;">
            
            <h1 style="font-size: 2.5em; color: #000; text-transform: uppercase; margin-top: 0; font-weight: bold;">
    {{ producto.nombre }}
</h1>
            
            <span class="text-4xl font-bold mb-4 text-[#A91B0D]">
                {{ producto.euros }},<span class="text-2xl">{{ producto.centavos|stringformat:"02d" }}€</span>
            </span>
            
            <p style="font-size: 1em; color: {% if producto.stock > 10 %} green {% else %} orang e{% endif %}; margin-bottom: 25px;">
                {% if producto.esta_agotado or producto.stock == 0 %}
<span class="text-red-600">
                            SIN PRODUCTO
                        </span>                {% elif producto.stock < 5 %}
                    ¡Últimas unidades! Almacenados: {{ producto.stock }}
                {% else %}
                    Productos disponibles: {{ producto.stock }} unidades
                {% endif %}
            </p>

            {% if not user.is_authenticated or not user.is_staff %}
            <div class="action-row" style="display: flex; align-items: center; gap: 20px; margin-bottom: 40px;">
                {% if producto.stock != 0 %}
                <form class="add-to-cart-form" data-product-id="{{ producto.id }}" style="display: flex; align-items: center; gap: 10px;">
                    {% csrf_token %}
                    <div class="quantity-control" style="display: flex; border: 1px solid #ccc; border-radius: 4px; overflow: hidden;">
    <!-- El botón de decremento -->
    <button type="button" onclick="changeQuantity(this, -1)" style="padding: 10px 15px; background-color: #f9f9f9; border: none; cursor: pointer;">-</button>
    
    <!-- Este input tiene el MAX dinámico de Django -->
    <input type="number" name="cantidad" class="quantity-input" value="1" min="1" max="{{ producto.stock }}" style="width: 60px; text-align: center; border: none; outline: none;">
    
    <!-- El botón de incremento -->
    <button type="button" onclick="changeQuantity(this, 1)" style="padding: 10px 15px; background-color: #f9f9f9; border: none; cursor: pointer;">+</button>
</div>
                    <button type="submit" class="add-to-cart-button" style="padding: 10px 20px; background-color: #bf7149; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Añadir a la Cesta
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}

            

        <div class="info-importante bg-white border border-gray-200 rounded-xl shadow-sm divide-y divide-gray-200 mt-6">

          
            <div class="flex items-start gap-3 p-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6  text-[#6a760c]  mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293A1 1 0 006 17h11a2 2 0 100 4 2 2 0 000-4H7z" />
                </svg>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900">Entrega en Tienda</h3><span class="text-gray-500">GRATIS</span>
                    <ul class="text-gray-700 text-sm space-y-1 mt-1">
                        <li class="flex items-center gap-2">
                            <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            Para una unidad, disponibilidad inmediata.                         
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            Para más de una unidad, disponible a partir de 2 horas tras hacer el pedido.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="flex items-start gap-3 p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[#6a760c] mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h18v13a2 2 0 01-2 2H5a2 2 0 01-2-2V3zM3 3l9 7 9-7" />
                </svg>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900">Entrega a Domicilio</h3>
                    <ul class="text-gray-700 text-sm space-y-1 mt-1">
                        <li class="flex items-center gap-2">
                            <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                            Entrega de producto en un plazo de 48 horas. Costes variables según el pedido.
                        </li>
                    </ul>
                </div>
            </div>

        </div>



        </div>


    </div>
    
    <div class="features-dropdown" style="
    max-width: 1200px; 
    margin: 20px auto; 
    padding: 20px; 
    border-top: 1px solid #ccc; 
    border: 1px solid #dcdcdc; /* Borde gris claro */
    border-radius: 8px; /* Opcional: para darle un toque moderno */
">
    <details open style="margin-top: 0;"> 
        <summary style="font-size: 1.5em; display: flex; align-items: center; gap: 10px; font-weight: bold; cursor: pointer; padding: 10px 0; list-style: none; ">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 lm-text-black mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                                <span class="text-black ">Características y Especificaciones</span>       
                             </summary>

        
        <div class="details-content" style="padding: 15px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 4px; margin-top: 10px;">
            
            <h3 style="font-size: 1.2em; margin-top: 0;">Descripción:</h3>
            <p>{{ producto.descripcion|linebreaksbr }}</p>
            
            <hr style="margin: 15px 0;">

            <p><strong>Fabricante:</strong> {{ producto.fabricante }}</p>
            
            {% load text_filters %}

            <p><strong>Categoría:</strong> {{ producto.categoria|espaciar }}</p>
            
            <p><strong>Sección:</strong> {{ producto.seccion|espaciar }}</p>

            <p><strong>Departamento:</strong> {{ producto.departamento }}</p>
        </div>
    </details>
</div>
<div class="related-products-section" style="max-width: 1200px; margin: 40px auto; padding: 20px;">

    <h2 style="font-size: 1.8em; text-align: center; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #ccc; padding-bottom: 5px;">
        Productos de la misma categoría
    </h2>

    {% if productos_relacionados %}

    <div class="carousel-container" style="position: relative;">

        <div id="product-carousel" class="product-list" style="
            display: flex;
            overflow-x: hidden;
            scroll-behavior: smooth;
            gap: 20px;
            padding: 40px 0;
            user-select: none;
        ">

            {% for relacionado in productos_relacionados %}
            <a href="{% url 'detalle_producto' pk=relacionado.pk %}"
               class="block bg-white rounded-lg p-3 flex flex-col items-center justify-between transition duration-300 ease-in-out transform hover:shadow-hard-halo hover:scale-[1.02]"
               style="flex: 0 0 calc(20% - 16px);">

                <!-- CONTENEDOR DE IMAGEN -->
                <div>
                    {% if relacionado.imagen %}
                    <div class="relative w-full h-32 mb-4 flex justify-center items-center">
                        <img src="{{ relacionado.imagen.url }}" alt="Imagen de {{ relacionado.nombre }}"
                             class="max-h-full max-w-full object-contain mix-blend-multiply">
                    </div>
                    {% else %}
                    <div class="relative w-full h-32 mb-4 flex justify-center items-center">
                        <img src="{% static 'imagen1.jpg' %}" alt="Imagen por defecto"
                             class="max-h-full max-w-full object-contain mix-blend-multiply">
                    </div>
                    {% endif %}

                    {% if relacionado.stock <= 0 %}
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="bg-red-500 text-white text-base font-bold text-center uppercase tracking-wider py-1 px-4 transform -rotate-45 whitespace-nowrap">
                            AGOTADO
                        </span>
                    </div>
                    {% endif %}
                </div>

                <!-- DETALLES DEL PRODUCTO -->
                <div class="w-full text-center flex-grow flex flex-col justify-end">

                    <h4 class="text-sm font-bold uppercase text-gray-900 leading-tight mb-1 line-clamp-2">
                        {{ relacionado.nombre|upper }}
                    </h4>

                    <p class="text-xs text-gray-500 mb-2">
                        Fabricante: {{ relacionado.fabricante }}
                    </p>

                    <div class="mb-3">
                        {% if relacionado.stock > 0 %}
                        <span class="text-sm font-semibold text-[#6a760c]">
                            {{ relacionado.stock }} unidades en el almacén
                        </span>
                        {% else %}
                        <span class="text-sm font-semibold text-red-600">
                            Sin productos
                        </span>
                        {% endif %}
                    </div>

                    <span class="text-4xl font-bold mb-4 text-[#A91B0D]">
                        {{ relacionado.euros }},<span class="text-2xl">{{ relacionado.centavos|stringformat:"02d" }}€</span>
                    </span>

                </div>

                <!-- BOTÓN AÑADIR -->
                 {% if not user.is_authenticated or not user.is_staff %}
                <button onclick="event.stopPropagation();"
                    class="add-related w-full py-2 bg-white text-[#bf7149] font-semibold rounded-md 
                        border-2 border-[#bf7149] hover:bg-[#bf7149] hover:text-white 
                        transition duration-150 relative z-10 mt-2"
                    data-product-id="{{ relacionado.pk }}">
                Añadir a la Cesta
                </button>
                {% endif %}


            </a>
            {% endfor %}

        </div>

        <!-- BOTÓN PREV -->
        <button id="prev-btn"
                class="absolute top-1/2 left-0 transform -translate-y-1/2 ml-4
                       w-10 h-10 flex items-center justify-center
                       bg-white rounded-lg shadow-hard-halo
                       hover:bg-gray-100 transition z-40">
            <svg class="h-6 w-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <!-- BOTÓN NEXT -->
        <button id="next-btn"
                class="absolute top-1/2 right-0 transform -translate-y-1/2 mr-4
                       w-10 h-10 flex items-center justify-center
                       bg-white rounded-lg shadow-hard-halo
                       hover:bg-gray-100 transition z-40">
            <svg class="h-6 w-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

    </div>

    {% else %}
    <div class="text-center text-gray-500 mt-8 mb-12">
        <p>No hay productos relacionados disponibles.</p>
    </div>
    {% endif %}

    {% if messages %}
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 space-y-2">
        {% for message in messages %}
        <div class="toast {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <style>
    .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: #16a34a; /* verde éxito */
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 9999;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    </style>


</div>


<script>
function changeQuantity(button, amount) {
        const quantityControl = button.parentElement;
        const input = quantityControl.querySelector('.quantity-input');
        const min = parseInt(input.min) || 1;
        const max = parseInt(input.max); // Stock
        
        let newValue = (parseInt(input.value) || 1) + amount;

        // Asegurarse de que el valor no sea menor que el mínimo
        if (newValue < min) {
            newValue = min;
        }
        
        // Asegurarse de que el valor no excede el stock (max)
        if (!isNaN(max) && newValue > max) {
            newValue = max;
        }
        
        input.value = newValue;
    }


    // ===============================================
    // SCRIPT PRINCIPAL DE LA PÁGINA
    // ===============================================
    document.addEventListener('DOMContentLoaded', function() {

        // ----- Lógica del Carrusel -----
        const carousel = document.getElementById('product-carousel');
        const prevButton = document.getElementById('prev-btn');
        const nextButton = document.getElementById('next-btn');
        
        const cardsToScroll = 3; 
        const gapSize = 20;
        
        let CARD_WIDTH_PLUS_GAP = 0;

        if (carousel && carousel.children.length > 0) {
            const firstCard = carousel.children[0];
            CARD_WIDTH_PLUS_GAP = firstCard.offsetWidth + gapSize;
        } else {
             CARD_WIDTH_PLUS_GAP = 260; // Fallback
        }
        
        const scrollAmount = CARD_WIDTH_PLUS_GAP * cardsToScroll; 

        if (carousel && prevButton && nextButton) {
            prevButton.addEventListener('click', (e) => {
                e.preventDefault();
                carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });

            nextButton.addEventListener('click', (e) => {
                e.preventDefault();
                carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });
        }

        // ----- Lógica del Carrito (Unificada) -----

        // ===== Función para mostrar toast =====
        function showToast(mensaje){
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = mensaje;
            document.body.appendChild(toast);

            void toast.offsetWidth; // Forzar reflow
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // ===== Función para actualizar badge =====
        function actualizarBadge(totalItems){
            const badge = document.querySelector('#cesta-badge');
            if(badge){
                badge.textContent = totalItems;
            } else {
                const cestaLink = document.querySelector('a[href="{% url "carrito:carrito" %}"]');
                if(cestaLink){
                    const span = document.createElement('span');
                    span.id = "cesta-badge";
                    span.className = "absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center";
                    span.textContent = totalItems;
                    cestaLink.appendChild(span);
                }
            }
        }

        // ===== Función genérica para agregar al carrito =====
        function agregarAlCarrito(productId, cantidad, csrfToken){
            fetch(`/cesta/agregar/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded' // Asegura el formato correcto
                },
                body: new URLSearchParams({ 'cantidad': cantidad })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    showToast(data.mensaje || 'Producto añadido');
                    actualizarBadge(data.total_items);
                } else {
                    showToast(data.mensaje || 'Error al añadir el producto');
                }
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                showToast('Error de conexión');
            });
        }

        // ===== Formulario del detalle del producto =====
        document.querySelectorAll('.add-to-cart-form').forEach(form => {
            form.addEventListener('submit', function(e){
                e.preventDefault();
                const productId = this.dataset.productId;
                const cantidad = parseInt(this.querySelector('.quantity-input').value) || 1;
                const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
                agregarAlCarrito(productId, cantidad, csrfToken);
            });
        });

        // ===== Botones de productos relacionados =====
        document.querySelectorAll('.add-related').forEach(btn => {
            btn.addEventListener('click', function(e){
                e.preventDefault(); // Evita navegar a la página del producto
                const productId = this.dataset.productId;
                const cantidad = 1; // siempre 1
                
                // ### CORRECCIÓN 2: Buscar CUALQUIER token en la página ###
                const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                
                if (csrfTokenInput) {
                    agregarAlCarrito(productId, cantidad, csrfTokenInput.value);
                } else {
                    console.error('No se pudo encontrar el CSRF token');
                    showToast('Error de seguridad. Recargue la página.');
                }
            });
        });

    });
</script>


</main>
{% endblock content %}

{% block extra_css %}
{% endblock extra_css %}