{% extends 'base_admin.html' %} 
{% load static %}

{% block title %}
    {% if es_edicion %}
        Editar Producto: {{ producto.nombre }}
    {% else %}
        Añadir Producto
    {% endif %}
{% endblock %}
{% block breadcrumbs %}
    
    <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
    
    <a href="{% url 'lista_productos' %}" class="hover:text-[#6a760c] font-medium text-gray-500 hover:underline">
        PRODUCTOS
    </a>

    <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
    {% if es_edicion %}
        <span class="text- font-medium text-gray-500 hover:text-[#bf7149]">
            EDITAR PRODUCTO: {{ producto.nombre }}
        </span>
    {% else %}
        <span class="text- font-medium text-gray-500 hover:text-[#bf7149]">
            AÑADIR PRODUCTO 
        </span>
    {% endif %}
    



{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-xl border border-gray-100">
    <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center lm-text-green">
        {% if es_edicion %}
            Editar Producto: {{ producto.nombre }}
        {% else %}
            Añadir Nuevo Producto
        {% endif %}
    </h1>
    
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Error:</strong>
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        {% for field in form %}
        <div class="border border-gray-200 rounded-lg p-3">
            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                {{ field.label }}
            </label>
            
            {# Aquí se renderiza el campo, incluyendo los IDs 'id_seccion' e 'id_categoria' #}
            {{ field }}
            
            {% if field.errors %}
                <ul class="mt-1 text-sm text-red-600 space-y-1">
                    {% for error in field.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            {% if field.help_text %}
                <p class="mt-2 text-sm text-gray-500">{{ field.help_text|safe }}</p>
            {% endif %}
        </div>
        {% endfor %}

        <div class="flex justify-between items-center pt-4">
            <a href="{% url 'lista_productos' %}" 
                class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-300 transition font-medium">
                Cancelar
            </a>
            <button type="submit" 
                    class="lm-green text-white px-5 py-2 rounded-lg hover:bg-[#bf7149] transition font-medium">
                {% if es_edicion %}
                    Guardar Cambios
                {% else %}
                    Guardar Producto
                {% endif %}
            </button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // 1. Identificar los campos SELECT por sus IDs generados por Django
    // Los IDs serán 'id_seccion' e 'id_categoria'
    const $seccionSelect = $("#id_seccion");
    const $categoriaSelect = $("#id_categoria");
    
    // Almacenar la categoría original para el modo edición
    // Se usa un valor por defecto (vacío) si el campo no tiene valor inicial
    const categoriaOriginal = $categoriaSelect.val() || ''; 
    
    function updateCategorias(isInitialLoad = false) {
        // Obtiene el valor (string) de la sección seleccionada
        const seccionValor = $seccionSelect.val();
        
        // Bloquea el campo de categoría si no hay sección seleccionada
        if (!seccionValor) {
            $categoriaSelect.empty().append('<option value="">Seleccione Sección primero</option>').prop('disabled', true);
            return;
        }

        // Si es carga inicial y la categoría ya está seleccionada y es válida, no hacer nada (para evitar borrarla en edición)
        if (isInitialLoad && categoriaOriginal) {
             // Opcional: Podrías deshabilitar el AJAX para la carga inicial si la categoría es válida,
             // pero es más seguro cargar igual para habilitar el filtrado si el usuario cambia la sección.
        }

        // Bloquea temporalmente para carga
        $categoriaSelect.empty().prop('disabled', true);
        $categoriaSelect.append('<option value="">Cargando categorías...</option>');

        // Petición AJAX a la vista de filtrado
        // Asegúrate de que 'cargar_categorias' esté definida en tu urls.py
        $.ajax({
            url: "{% url 'cargar_categorias' %}", 
            data: {
                // Enviamos el valor (string) de la sección, no un ID de BD
                'seccion_valor': seccionValor
            },
            dataType: 'json',
            success: function (data) {
                $categoriaSelect.empty().prop('disabled', false);
                $categoriaSelect.append('<option value="">-------</option>'); // Opción por defecto
                
                let foundOriginal = false;
                
                $.each(data.categorias, function (index, categoria) {
                    // Usamos el 'nombre' como valor y como texto, ya que no hay IDs
                    const optionValue = categoria.nombre;
                    const $option = $('<option></option>').val(optionValue).text(optionValue);
                    
                    // En modo edición, si el valor coincide con la categoría original, la seleccionamos
                    if (isInitialLoad && categoriaOriginal && optionValue === categoriaOriginal) {
                        $option.attr('selected', 'selected');
                        foundOriginal = true;
                    }
                    
                    $categoriaSelect.append($option);
                });

                // En modo edición, si la categoría original no se encuentra, es inválida.
                // Podrías agregar un mensaje de error visual si esto sucede.
                if (isInitialLoad && categoriaOriginal && !foundOriginal) {
                    console.warn("Categoría original no válida para la sección actual.");
                    // Opcional: Añadir un mensaje de error al campo aquí
                }
            },
            error: function() {
                $categoriaSelect.empty().append('<option value="">Error al cargar categorías</option>').prop('disabled', true);
            }
        });
    }
    
    // 2. Ejecutar la función cuando cambia la selección de Sección
    $seccionSelect.change(function() {
        updateCategorias(false); // No es carga inicial, es un cambio de usuario
    });

    // 3. Ejecutar la función al cargar la página si ya hay una sección seleccionada
    // Esto es crucial para el modo EDICIÓN.
    if ($seccionSelect.val()) {
        updateCategorias(true); // Es carga inicial
    } else {
        // Inicializar la categoría como deshabilitada si no hay sección
        $categoriaSelect.empty().append('<option value="">Seleccione Sección primero</option>').prop('disabled', true);
    }
});
</script>

{% endblock content %}