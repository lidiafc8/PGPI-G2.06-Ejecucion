{% extends "base.html" %}
{% block breadcrumbs %}
    <li>
        <span class="text-lg text-gray-500">></span>

        <a href="{% url 'carrito:carrito' %}" class="text-sm font-medium text-gray-500 hover:text-[#bf7149]">CARRITO</a>
    </li>
    <li>
        <span class="text-lg text-gray-500">></span>
        <span class="text-sm font-medium text-gray-500 hover:text-[#bf7149]">
            PAGO
        </span>
    </li>
{% endblock breadcrumbs %}

{% block content %}
{% load static %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Proceso de Pago</h1>
    <hr class="mb-8">
{% if messages %}
    <div class="mb-6 space-y-3">
        {% for message in messages %}
            <div class="p-4 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300{% elif message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %} shadow-md" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}
    <form id="payment-form" method="POST" action="{% url 'carrito:procesar_pago' %}">
        {% csrf_token %}
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="lg:w-2/3 space-y-8">
                
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Direcci√≥n y Tipo de Env√≠o</h2>
                    
                    <div class="space-y-4">
                        <label class="block">
                            <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                                <input type="radio" id="shipping-standard" name="shipping_option" value="standard" {% if datos_cliente.tipo_envio_default == 'DOMICILIO' %}checked{% endif %} class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                                <div class="flex-grow">
                                    <p class="font-medium text-gray-800">Env√≠o a Domicilio</p>
                                    <p class="text-sm text-gray-500">Entrega en 48 horas. (5‚Ç¨, gratis a partir de 50‚Ç¨)</p>
                                </div>
                                <span class="font-bold text-sm " data-coste="{% if coste_envio > 0 %}{{ coste_envio }}{% else %}0{% endif %}">{% if coste_envio > 0 %}{{coste_envio}} ‚Ç¨{% else %}GRATIS{% endif %}</span>
                            </div>
                        </label>
                        
                        <div id="shipping-details-standard" class="p-4 border border-green-200 bg-[#f9fdf2] rounded-lg space-y-3">
                            <p class="font-semibold text-gray-700">Introduce o selecciona tu direcci√≥n de env√≠o:</p>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                <div>
                                    <label for="address_street" class="block text-sm font-medium text-gray-700">Calle y N√∫mero</label>
                                    <input type="text" id="address_street" name="address_street" value="{{ datos_cliente.direccion_calle|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: Av. Principal 123" required>
                                </div>
                                <div>
                                    <label for="address_city" class="block text-sm font-medium text-gray-700">Ciudad</label>
                                    <input type="text" id="address_city" name="address_city" value="{{ datos_cliente.direccion_ciudad|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: Sevilla" required>
                                </div>
                                <div>
                                    <label for="address_zip" class="block text-sm font-medium text-gray-700">C√≥digo Postal</label>
                                    <input type="text" id="address_zip" name="address_zip" value="{{ datos_cliente.direccion_cp|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Tu Postal" required>
                                </div>
                                <div>
                                    <label for="address_country" class="block text-sm font-medium text-gray-700">Pa√≠s</label>
                                    <input type="text" id="address_country" name="address_country" value="{{ datos_cliente.direccion_pais|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: Espa√±a" required>
                                </div>
                            </div>
                        </div>

                        <label class="block">
                            <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                                <input type="radio" id="shipping-pickup" name="shipping_option" value="express" {% if datos_cliente.tipo_envio_default == 'RECOGIDA_TIENDA' %}checked{% endif %} class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                                <div class="flex-grow">
                                    <p class="font-medium text-gray-800">Recogida en Tienda</p>
                                    <p class="text-sm text-gray-500">Disponible para recoger en 24 horas.</p>
                                </div>
                                <span class="font-bold text-sm ">GRATIS</span>
                            </div>
                        </label>

                        <div id="pickup-details-message" class="p-4 border border-orange-200 bg-orange-50 rounded-lg hidden">
                            <p class="font-semibold text-gray-700">Ubicaci√≥n de Recogida:</p>
                            <p class="text-sm text-gray-600">Puedes recoger tu pedido en nuestra tienda f√≠sica:</p>
                            <p class="text-sm text-gray-600 mt-1">Calle Jardines del Guadalquivir, 45, 41012 Sevilla, Espa√±a</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. M√©todo de Pago</h2>
                    
                    <div class="space-y-4">
                        <label for="payment-gateway" class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                            <input type="radio" id="payment-gateway" name="payment_method" value="gateway" 
                                {% if datos_cliente.tipo_pago_default == 'PASARELA_PAGO' %}checked{% endif %} 
                                class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                            <span class="font-medium text-gray-800">Pasarela de Pago (Tarjeta Cr√©dito/D√©bito)</span>
                        </label>
                        
                        {# INICIO DE LA SECCI√ìN DE TARJETA MODIFICADA #}
                        <div id="gateway-details" class="p-4 border border-green-200 bg-[#f9fdf2] rounded-lg space-y-3">
                            
                            {# BLOQUE DE SELECCI√ìN DE TARJETAS #}
                            {% if tiene_tarjeta_guardada %}
                                <div class="space-y-2">
                                    <label for="select_card" class="block text-sm font-medium text-gray-700">Seleccionar Tarjeta Guardada:</label>
                                    <div class="flex gap-2">
                                        <select id="select_card" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500">
                                            {% for tarjeta in tarjetas_para_contexto %}
                                                <option 
                                                    value="{{ tarjeta.id }}" 
                                                    data-fecha="{{ tarjeta.fecha_expiracion }}"
                                                    data-ultimos="{{ tarjeta.ultimos_cuatro }}"
                                                    {% if forloop.first %}selected{% endif %}>
                                                    {{ tarjeta.numero_enmascarado }}
                                                </option>
                                            {% endfor %}
                                            <option value="nueva">Usar una nueva tarjeta</option>
                                        </select>
                                        <button type="button" id="manage_cards_btn" class="text-sm px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 whitespace-nowrap">
                                            Gestionar
                                        </button>
                                    </div>
                                    <input type="hidden" id="selected_card_id" name="selected_card_id" 
                                        value="{% if tiene_tarjeta_guardada %}{{ tarjetas_para_contexto.0.id }}{% else %}nueva{% endif %}">
                                </div>
                                <hr class="my-3">
                            {% endif %}
                            
                            <p class="font-semibold text-gray-700">Datos de la Tarjeta:</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label for="card_number" class="block text-sm font-medium text-gray-700">N√∫mero de Tarjeta (16 d√≠gitos)</label>
                                    <input type="text" id="card_number" name="card_number" inputmode="numeric" pattern="\d{16}" maxlength="16" 
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" 
                                        placeholder="XXXX XXXX XXXX XXXX" required 
                                        {% if tiene_tarjeta_guardada %}
                                        value="{{ tarjetas_para_contexto.0.numero_enmascarado }}" readonly
                                        {% endif %}>
                                </div>
                                <div>
                                    <label for="expiry_date" class="block text-sm font-medium text-gray-700">Fecha de Caducidad (MM/AA)</label>
                                    <input type="text" id="expiry_date" name="expiry_date" inputmode="numeric" pattern="(0[1-9]|1[0-2])\/\d{2}" maxlength="5" 
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" 
                                        placeholder="MM/AA" required 
                                        {% if tiene_tarjeta_guardada %}
                                        value="{{ tarjetas_para_contexto.0.fecha_expiracion }}" readonly
                                        {% endif %}>
                                </div>
                                <div>
                                    <label for="cvv" class="block text-sm font-medium text-gray-700">CVV (3 d√≠gitos)</label>
                                    <input type="text" id="cvv" name="cvv" inputmode="numeric" pattern="\d{3}" maxlength="3" 
                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" 
                                        placeholder="123" required 
                                        value="">
                                </div>
                            </div>
                            
                            {# L√ìGICA CONDICIONAL DE GUARDADO DE TARJETA #}
                            <div id="save_card_checkbox_container" {% if tiene_tarjeta_guardada %}class="hidden"{% endif %}>
                                {% if user.is_authenticated %}
                                    <div class="flex items-center mt-3">
                                        <input type="checkbox" id="save_card" name="save_card" class="form-checkbox h-4 w-4 text-green-600 rounded focus:ring-green-500">
                                        <label for="save_card" class="ml-2 block text-sm text-gray-900">
                                            Guardar esta tarjeta para futuras compras.
                                        </label>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div id="saved_card_info_message" {% if not tiene_tarjeta_guardada %}class="hidden"{% endif %} class="mt-3 p-3 bg-green-50 rounded-lg text-sm text-gray-700">
                                üí≥ **Tarjeta Guardada Seleccionada.** Por seguridad, solo se muestra el n√∫mero enmascarado y **debes introducir el CVV** en cada compra.
                            </div>
                            
                        </div>
                        {# FIN DE LA SECCI√ìN DE TARJETA MODIFICADA #}
                        
                        <div class="h-px bg-gray-200 my-4"></div>

                        <label for="payment-cash" class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                            <input type="radio" id="payment-cash" name="payment_method" value="cash" {% if datos_cliente.tipo_pago_default == 'CONTRAREEMBOLSO' %}checked{% endif %} class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                            <span class="font-medium text-gray-800">Contrarrembolso</span>
                        </label>
                        
                        <div id="cash-details" class="p-4 border border-orange-200 bg-orange-50 rounded-lg hidden">
                            <p class="font-semibold text-gray-700">Confirmaci√≥n y Costes:</p>
                            <p class="text-sm text-gray-600">El pago se realizar√° en efectivo al repartidor en el momento de la entrega.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Datos de Contacto</h2>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label for="contact_first_name" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <input type="text" id="contact_first_name" name="contact_first_name" value="{{ datos_cliente.nombre|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Tu nombre" required>
                        </div>
                        <div>
                            <label for="contact_last_name" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input type="text" id="contact_last_name" name="contact_last_name" value="{{ datos_cliente.apellidos|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Tus apellidos" required>
                        </div>
                        <div class="sm:col-span-2">
                            <label for="contact_email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="contact_email" name="contact_email" value="{{ datos_cliente.email|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Tu email" required>
                        </div>
                        <div>
                            <label for="contact_phone" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                           <input type="tel" id="contact_phone" name="contact_phone" value="{{ datos_cliente.telefono|default:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: 600123456" required>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="lg:w-1/3 space-y-4 sticky top-4"> 
                
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen del Pedido</h2>
                    
                    <div class="bg-gray-100 p-4 rounded-lg space-y-2">
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>Subtotal ({{ articulos|length }} productos)</span>
                            <span class="font-medium" id="subtotal_value">{{ subtotal }}</span> ‚Ç¨
                        </div>
                        <div class="flex justify-between text-sm text-gray-700" id="gastos_envio_linea">
                            <span>Gastos de env√≠o:</span>
                            <span class="font-medium text-[#bf7149]" id="shipping_cost_display">
                                {% if coste_envio > 0 %}+ {{coste_envio}} ‚Ç¨ (Est.){% else %}GRATIS{% endif %}
                            </span>
                        </div>
                        
                        
                        <div class="h-px bg-gray-300 my-3"></div> 
                        
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-xl font-bold text-gray-800">Total a Pagar</span>
                            <span class="text-2xl font-extrabold text-gray-800" id="total_value_display">{{ total }} ‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <button type="submit" class="w-full bg-[#6a760c] hover:bg-[#bf7149] text-white font-bold py-3 rounded-md transition duration-150">
                        Confirmar Compra
                    </button>
                    <a href="{% url 'carrito:carrito' %}" class="block">
                        <button type="button" class="add-related w-full py-2 bg-white text-[#bf7149] font-semibold rounded-md 
                                     border-2 border-[#bf7149] hover:bg-[#bf7149] hover:text-white 
                                     transition duration-150 relative z-10 ">
                            Volver al Carrito
                        </button>
                    </a>
                </div>
                <p class="text-xs text-center text-gray-500 mt-3">T√âRMINOS Y CONDICIONES: no se aceptar√°n devoluciones de ning√∫n tipo as√≠ como tampoco se aceptar√°n cancelaciones de pedidos ya realizados y pagados. Al confirmar la compra, aceptas nuestros t√©rminos y condiciones.</p>

            </div>
            
        </div>
    </form>
</div>

<script>
 
    /**
     * Valida si la cadena tiene el formato MM/AA y no ha expirado.
     * @param {string} date - La fecha en formato MM/AA.
     */
    function isValidExpiryDate(date) {
        const pattern = /^(0[1-9]|1[0-2])\/\d{2}$/;
        if (!pattern.test(date)) {
            return false;
        }
        
        const [month, yearStr] = date.split('/');
        const now = new Date();
        const currentYear = now.getFullYear() % 100;
        const currentMonth = now.getMonth() + 1;

        const inputYear = parseInt(yearStr, 10);
        const inputMonth = parseInt(month, 10);

        if (inputYear > currentYear) {
            return true;
        }
        
        if (inputYear === currentYear && inputMonth >= currentMonth) {
            return true;
        }
        
        return false;
    }

    /**
     * Valida si el n√∫mero de tarjeta es un n√∫mero de 16 d√≠gitos.
     * Si el campo es de solo lectura (tarjeta guardada), solo valida el formato.
     * @param {string} cardNumber - El n√∫mero de tarjeta.
     */
    function isValidCardNumber(cardNumber) {
        // Si el campo es de solo lectura (readonly) y empieza con '*', asumimos que es una tarjeta guardada
        if (cardNumberInput.readOnly && cardNumber.startsWith('*')) {
            // Validamos que el formato enmascarado sea correcto (ej: ************1111)
            return /^[*]{12}\d{4}$/.test(cardNumber);
        }
        
        // Para una tarjeta nueva, validamos 16 d√≠gitos.
        const cleaned = cardNumber.replace(/[\s-]/g, '');
        return /^\d{16}$/.test(cleaned);
    }

    /**
     * Valida si el CVV es un n√∫mero de 3 d√≠gitos.
     * @param {string} cvv - El CVV.
     */
    function isValidCVV(cvv) {
        return /^\d{3}$/.test(cvv);
    }


    document.addEventListener('DOMContentLoaded', function() {
        const paymentForm = document.getElementById('payment-form');
        
        // Bloque de Elementos de Pago
        const gatewayRadio = document.getElementById('payment-gateway');
        const cashRadio = document.getElementById('payment-cash');
        const gatewayDetails = document.getElementById('gateway-details');
        const cashDetails = document.getElementById('cash-details');
        
        // Bloque de Inputs de Tarjeta
        const cardNumberInput = document.getElementById('card_number');
        const expiryDateInput = document.getElementById('expiry_date');
        const cvvInput = document.getElementById('cvv');

        // NUEVOS ELEMENTOS DE SELECCI√ìN DE TARJETA
        const selectCard = document.getElementById('select_card');
        const selectedCardIdInput = document.getElementById('selected_card_id');
        const saveCardCheckboxContainer = document.getElementById('save_card_checkbox_container');
        const savedCardInfoMessage = document.getElementById('saved_card_info_message');
        const manageCardsBtn = document.getElementById('manage_cards_btn');
        // FIN NUEVOS ELEMENTOS

        // Bloque de Elementos de Env√≠o
        const shippingStandardRadio = document.getElementById('shipping-standard');
        const shippingPickupRadio = document.getElementById('shipping-pickup');
        const shippingDetailsStandard = document.getElementById('shipping-details-standard');
        const pickupDetailsMessage = document.getElementById('pickup-details-message');
        
        // Bloque de Inputs de Direcci√≥n
        const addressStreetInput = document.getElementById('address_street');
        const addressCityInput = document.getElementById('address_city');
        const addressZipInput = document.getElementById('address_zip');
        const addressCountryInput = document.getElementById('address_country');

        // Referencias para el resumen de pedido
        const shippingCostDisplay = document.getElementById('shipping_cost_display');
        const totalValueDisplay = document.getElementById('total_value_display');
        const subtotalElement = document.getElementById('subtotal_value');

        // Valores iniciales
        const initialShippingCostSpan = shippingStandardRadio.closest('label').querySelector('span[data-coste]');
        const initialShippingCost = parseFloat(initialShippingCostSpan ? initialShippingCostSpan.dataset.coste : 0) || 0;
        const subtotal = parseFloat(subtotalElement.textContent.trim().replace(/[‚Ç¨\s]/g, '')) || 0;


        // --- L√ìGICA DE SELECCI√ìN DE TARJETA (NUEVA) ---
        function handleCardSelection() {
            if (!selectCard) return; // Salir si no hay selector (e.g., usuario no autenticado o sin tarjetas)
            
            const selectedOption = selectCard.options[selectCard.selectedIndex];
            const cardValue = selectedOption.value; // ID de la tarjeta o 'nueva'

            if (cardValue === 'nueva') {
                // Tarjeta Nueva: Campos vac√≠os y editables
                cardNumberInput.value = '';
                expiryDateInput.value = '';
                
                cardNumberInput.readOnly = false;
                expiryDateInput.readOnly = false;
                
                // Mostrar opci√≥n de guardar y ocultar mensaje de tarjeta guardada
                if (saveCardCheckboxContainer) saveCardCheckboxContainer.classList.remove('hidden');
                if (savedCardInfoMessage) savedCardInfoMessage.classList.add('hidden');

            } else {
                // Tarjeta Guardada: Campos rellenos con enmascaramiento y NO editables (excepto CVV)
                const maskedNumber = selectedOption.textContent.trim();
                const expiryDate = selectedOption.dataset.fecha;
                
                // Rellenar campos
                cardNumberInput.value = maskedNumber;
                expiryDateInput.value = expiryDate;
                cvvInput.value = ''; // CVV siempre vac√≠o
                
                // Deshabilitar la edici√≥n y mostrar mensaje de tarjeta guardada
                cardNumberInput.readOnly = true;
                expiryDateInput.readOnly = true;
                if (saveCardCheckboxContainer) saveCardCheckboxContainer.classList.add('hidden');
                if (savedCardInfoMessage) savedCardInfoMessage.classList.remove('hidden');
            }
            
            selectedCardIdInput.value = cardValue; // Actualizar el ID para el env√≠o al backend
            cvvInput.focus(); // Enfoque en el CVV
        }
        
        // Inicializar el estado de solo lectura para la primera tarjeta si existe
        if (selectCard) {
            selectCard.addEventListener('change', handleCardSelection);
            
            // Opcional: listener para el bot√≥n de gestionar
            if (manageCardsBtn) {
                manageCardsBtn.addEventListener('click', function() {
                    alert('Navegando a la p√°gina de Gesti√≥n de Tarjetas.');
                    // window.location.href = '/ruta-a-gestion-de-tarjetas'; 
                });
            }
        }
        // --- FIN L√ìGICA DE SELECCI√ìN DE TARJETA ---


        // --- L√≥gica de Tipo de Pago (Modificada para siempre mostrar los detalles si se selecciona) ---
        function togglePaymentDetails() {
            if (gatewayRadio.checked) {
                gatewayDetails.classList.remove('hidden');
                cashDetails.classList.add('hidden');
                
                // Requerir campos de tarjeta
                cardNumberInput.required = true;
                expiryDateInput.required = true;
                cvvInput.required = true;

            } else if (cashRadio.checked) {
                gatewayDetails.classList.add('hidden');
                cashDetails.classList.remove('hidden');
                
                // No requerir campos de tarjeta
                cardNumberInput.required = false;
                expiryDateInput.required = false;
                cvvInput.required = false;
            }
        }

        // --- L√≥gica de Tipo de Env√≠o (Sin cambios) ---
        function updateShippingCostAndAddress() {
            let currentShippingCost = 0;
            let shippingText = '';

            if (shippingPickupRadio.checked) {
                currentShippingCost = 0;
                shippingText = 'GRATIS';
                
                pickupDetailsMessage.classList.remove('hidden');
                shippingDetailsStandard.classList.add('hidden');

                addressStreetInput.required = false;
                addressCityInput.required = false;
                addressZipInput.required = false;
                addressCountryInput.required = false;

                shippingCostDisplay.classList.remove('text-[#bf7149]');
                shippingCostDisplay.classList.add('text-[#6a760c]', 'font-bold');

            } else {
                currentShippingCost = initialShippingCost;
                shippingText = `+ ${currentShippingCost.toFixed(2)} ‚Ç¨ (Est.)`;
                
                pickupDetailsMessage.classList.add('hidden');
                shippingDetailsStandard.classList.remove('hidden');

                addressStreetInput.required = true;
                addressCityInput.required = true;
                addressZipInput.required = true;
                addressCountryInput.required = true;
                
                shippingCostDisplay.classList.remove('text-[#6a760c]', 'font-bold');
                shippingCostDisplay.classList.add('text-[#bf7149]');
            }

            shippingCostDisplay.innerHTML = shippingText;
            const newTotal = subtotal + currentShippingCost;
            totalValueDisplay.textContent = `${newTotal.toFixed(2)} ‚Ç¨`;
        }
        
        // --- Event Listener para Validaci√≥n de Formulario (Modificada para aceptar enmascaramiento) ---
        paymentForm.addEventListener('submit', function(e) {
            
            if (gatewayRadio.checked) {
                const cardNumber = cardNumberInput.value.trim();
                const expiryDate = expiryDateInput.value.trim();
                const cvv = cvvInput.value.trim();

                let validationError = null;

                // VALIDACI√ìN MEJORADA (utiliza la l√≥gica de readonly)
                if (!isValidCardNumber(cardNumber)) {
                    validationError = 'Por favor, introduce un n√∫mero de tarjeta v√°lido (16 d√≠gitos) o selecciona una tarjeta guardada.';
                } else if (!isValidExpiryDate(expiryDate)) {
                    validationError = 'La fecha de caducidad es incorrecta (formato MM/AA) o la tarjeta ha expirado.';
                } else if (!isValidCVV(cvv)) {
                    validationError = 'El CVV debe ser un c√≥digo de 3 d√≠gitos.';
                }
                
                if (validationError) {
                    e.preventDefault();
                    alert('Error de Pago: ' + validationError); 
                    
                    if (!isValidCardNumber(cardNumber)) cardNumberInput.focus();
                    else if (!isValidExpiryDate(expiryDate)) expiryDateInput.focus();
                    else cvvInput.focus();
                    
                    return;
                }
            }
        });


        // Event Listeners para Tipo de Pago
        gatewayRadio.addEventListener('change', togglePaymentDetails);
        cashRadio.addEventListener('change', togglePaymentDetails);
        
        // Event Listeners para Tipo de Env√≠o
        shippingStandardRadio.addEventListener('change', updateShippingCostAndAddress);
        shippingPickupRadio.addEventListener('change', updateShippingCostAndAddress);

        // Ejecutar al cargar la p√°gina para establecer el estado inicial
        togglePaymentDetails();
        updateShippingCostAndAddress();
    });
</script>
{% endblock content %}