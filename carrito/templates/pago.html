{% extends "base.html" %}
{% block breadcrumbs %}
    <li>
        <span class="text-lg text-gray-500">></span>

        <a href="{% url 'carrito:carrito' %}" class="text-sm font-medium text-gray-500 hover:text-[#bf7149]">CARRITO</a>
    </li>
    <li>
        <span class="text-lg text-gray-500">></span>
        <span class="text-sm font-medium text-gray-500 hover:text-[#bf7149]">
            PAGO
        </span>
    </li>
{% endblock breadcrumbs %}

{% block content %}
{% load static %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Proceso de Pago</h1>
            <hr class="mb-8">
{% if messages %}
    <div class="mb-6 space-y-3">
        {% for message in messages %}
            <div class="p-4 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300{% elif message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %} shadow-md" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}
    <form id="payment-form" method="POST" action="{% url 'carrito:procesar_pago' %}">
        {% csrf_token %}
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="lg:w-2/3 space-y-8">
                
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Dirección y Tipo de Envío</h2>
                    
                    <div class="space-y-4">
                        <label class="block">
                            <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                                <input type="radio" id="shipping-standard" name="shipping_option" value="standard" checked class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                                <div class="flex-grow">
                                    <p class="font-medium text-gray-800">Envío a Domicilio</p>
                                    <p class="text-sm text-gray-500">Entrega en 48 horas. (5€, gratis a partir de 50€)</p>
                                </div>
                                <span class="font-bold text-sm " data-coste="{{ coste_envio }}">{{coste_envio}} €</span>
                            </div>
                        </label>
                        
                        <div id="shipping-details-standard" class="p-4 border border-green-200 bg-[#f9fdf2] rounded-lg space-y-3">
                            <p class="font-semibold text-gray-700">Introduce o selecciona tu dirección de envío:</p>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                <div>
                                    <label for="address_street" class="block text-sm font-medium text-gray-700">Calle y Número</label>
                                    <input type="text" id="address_street" name="address_street" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: Av. Principal 123" required>
                                </div>
                                <div>
                                    <label for="address_city" class="block text-sm font-medium text-gray-700">Ciudad</label>
                                    <input type="text" id="address_city" name="address_city" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: Madrid" required>
                                                                </div>
                                <div>
                                    <label for="address_zip" class="block text-sm font-medium text-gray-700">Código Postal</label>
                                    <input type="text" id="address_zip" name="address_zip" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: 28001" required>
                                </div>
                                <div>
                                    <label for="address_country" class="block text-sm font-medium text-gray-700">País</label>
                                    <input type="text" id="address_country" name="address_country" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: España" required>
                                </div>
                            </div>
                        </div>

                        <label class="block">
                            <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                                <input type="radio" id="shipping-pickup" name="shipping_option" value="pickup" class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                                <div class="flex-grow">
                                    <p class="font-medium text-gray-800">Recogida en Tienda</p>
                                    <p class="text-sm text-gray-500">Disponible para recoger en 24 horas.</p>
                                </div>
                                <span class="font-bold text-sm ">GRATIS</span>
                            </div>
                        </label>

                        <div id="pickup-details-message" class="p-4 border border-orange-200 bg-orange-50 rounded-lg hidden">
                            <p class="font-semibold text-gray-700">Ubicación de Recogida:</p>
                            <p class="text-sm text-gray-600">Puedes recoger tu pedido en nuestra tienda física:</p>
                            <p class="text-sm text-gray-600 mt-1">Calle Jardines del Guadalquivir, 45, 41012 Sevilla, España</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Método de Pago</h2>
                    
                    <div class="space-y-4">
                        <label for="payment-gateway" class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                            <input type="radio" id="payment-gateway" name="payment_method" value="gateway" checked class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                            <span class="font-medium text-gray-800">Pasarela de Pago (Tarjeta Crédito/Débito)</span>
                        </label>
                        
                        <div id="gateway-details" class="p-4 border border-green-200 bg-[#f9fdf2] rounded-lg space-y-3">
                            <p class="font-semibold text-gray-700">Introduce los datos de tu tarjeta:</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label for="card_number" class="block text-sm font-medium text-gray-700">Número de Tarjeta</label>
                                    <input type="text" id="card_number" name="card_number" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="XXXX XXXX XXXX XXXX" required>
                                </div>
                                <div>
                                    <label for="expiry_date" class="block text-sm font-medium text-gray-700">Fecha de Caducidad (MM/AA)</label>
                                    <input type="text" id="expiry_date" name="expiry_date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="MM/AA" required>
                                </div>
                                <div>
                                    <label for="cvv" class="block text-sm font-medium text-gray-700">CVV</label>
                                    <input type="text" id="cvv" name="cvv" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="123" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="h-px bg-gray-200 my-4"></div>

                        <label for="payment-cash" class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:border-[#6a760c]">
                            <input type="radio" id="payment-cash" name="payment_method" value="cash" class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                            <span class="font-medium text-gray-800">Contrarrembolso</span>
                        </label>
                        
                        <div id="cash-details" class="p-4 border border-orange-200 bg-orange-50 rounded-lg hidden">
                            <p class="font-semibold text-gray-700">Confirmación y Costes:</p>
                            <p class="text-sm text-gray-600">El pago se realizará en efectivo al repartidor en el momento de la entrega.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Datos de Contacto</h2>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label for="contact_first_name" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <input type="text" id="contact_first_name" name="contact_first_name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Tu nombre" required>
                        </div>
                        <div>
                            <label for="contact_last_name" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input type="text" id="contact_last_name" name="contact_last_name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Tus apellidos" required>
                        </div>
                        <div class="sm:col-span-2">
                            <label for="contact_email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="contact_email" name="contact_email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="ejemplo@correo.com" required>
                        </div>
                        <div>
                            <label for="contact_phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                            <input type="tel" id="contact_phone" name="contact_phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:border-green-500 focus:ring-green-500" placeholder="Ej: 600123456" required>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="lg:w-1/3 space-y-4 sticky top-4"> 
                
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen del Pedido</h2>
                    
                    <div class="bg-gray-100 p-4 rounded-lg space-y-2">
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>Subtotal ({{ articulos|length }} productos)</span>
                            <span class="font-medium" id="subtotal_value">{{ subtotal }}</span> €
                        </div>
                        <div class="flex justify-between text-sm text-gray-700" id="gastos_envio_linea">
                            <span>Gastos de envío:</span>
                            <span class="font-medium text-[#bf7149]" id="shipping_cost_display">
                                + {{coste_envio}} € (Est.)
                            </span>
                        </div>
                        
                        
                        <div class="h-px bg-gray-300 my-3"></div> 
                        
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-xl font-bold text-gray-800">Total a Pagar</span>
                            <span class="text-2xl font-extrabold text-gray-800" id="total_value_display">{{ total }} €</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <button type="submit" class="w-full bg-[#6a760c] hover:bg-[#bf7149] text-white font-bold py-3 rounded-md transition duration-150">
                        Confirmar Compra
                    </button>
                    <a href="{% url 'carrito:carrito' %}" class="block">
                        <button type="button" class="add-related w-full py-2 bg-white text-[#bf7149] font-semibold rounded-md 
                                 border-2 border-[#bf7149] hover:bg-[#bf7149] hover:text-white 
                                 transition duration-150 relative z-10 ">
                            Volver al Carrito
                        </button>
                    </a>
                </div>
                <p class="text-xs text-center text-gray-500 mt-3">TÉRMINOS Y CONDICIONES: no se aceptarán devoluciones de ningún tipo así como tampoco se aceptarán cancelaciones de pedidos ya realizados y pagados. Al confirmar la compra, aceptas nuestros términos y condiciones.</p>

            </div>
            
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Bloque de Elementos de Pago
        const gatewayRadio = document.getElementById('payment-gateway');
        const cashRadio = document.getElementById('payment-cash');
        const gatewayDetails = document.getElementById('gateway-details');
        const cashDetails = document.getElementById('cash-details');
        
        // Bloque de Inputs de Tarjeta
        const cardNumberInput = document.getElementById('card_number');
        const expiryDateInput = document.getElementById('expiry_date');
        const cvvInput = document.getElementById('cvv');

        // Bloque de Elementos de Envío
        const shippingStandardRadio = document.getElementById('shipping-standard');
        const shippingPickupRadio = document.getElementById('shipping-pickup');
        const shippingDetailsStandard = document.getElementById('shipping-details-standard'); // Nuevo desplegable de dirección
        const pickupDetailsMessage = document.getElementById('pickup-details-message');     // Nuevo mensaje de tienda
        
        // Bloque de Inputs de Dirección
        const addressStreetInput = document.getElementById('address_street');
        const addressCityInput = document.getElementById('address_city');
        const addressZipInput = document.getElementById('address_zip');
        const addressCountryInput = document.getElementById('address_country');

        // Referencias para el resumen de pedido
        const shippingCostDisplay = document.getElementById('shipping_cost_display');
        const totalValueDisplay = document.getElementById('total_value_display');
        const subtotalElement = document.getElementById('subtotal_value');

        // Valores iniciales (se asume que {{ coste_envio }} y {{ subtotal }} son flotantes o números en el contexto de Django)
        // Usamos la propiedad data-coste del span hermano del radio button estándar
        const initialShippingCostSpan = shippingStandardRadio.closest('label').querySelector('span[data-coste]');
        const initialShippingCost = parseFloat(initialShippingCostSpan ? initialShippingCostSpan.dataset.coste : 0) || 0;
        const subtotal = parseFloat(subtotalElement.textContent.trim()) || 0;


        // --- Lógica de Tipo de Pago (Existente) ---
        function togglePaymentDetails() {
            if (gatewayRadio.checked) {
                // Mostrar detalles de tarjeta, hacer campos requeridos
                gatewayDetails.classList.remove('hidden');
                cashDetails.classList.add('hidden');
                
                cardNumberInput.required = true;
                expiryDateInput.required = true;
                cvvInput.required = true;

            } else if (cashRadio.checked) {
                // Ocultar detalles de tarjeta, quitar el requisito
                gatewayDetails.classList.add('hidden');
                cashDetails.classList.remove('hidden');
                
                cardNumberInput.required = false;
                expiryDateInput.required = false;
                cvvInput.required = false;
            }
        }

        // --- Lógica de Tipo de Envío (Modificada) ---
        function updateShippingCostAndAddress() {
            let currentShippingCost = 0;
            let shippingText = '';

            if (shippingPickupRadio.checked) {
                // Opción Recogida en Tienda (Gratis)
                currentShippingCost = 0;
                shippingText = 'GRATIS';
                
                // Mostrar mensaje de recogida, ocultar detalles de dirección, quitar requisitos de dirección
                pickupDetailsMessage.classList.remove('hidden');
                shippingDetailsStandard.classList.add('hidden');

                addressStreetInput.required = false;
                addressCityInput.required = false;
                addressZipInput.required = false;
                addressCountryInput.required = false;

                // Estilo para GRATIS
                shippingCostDisplay.classList.remove('text-[#bf7149]');
                shippingCostDisplay.classList.add('text-[#6a760c]', 'font-bold');

            } else {
                // Opción Envío a Domicilio (Estándar)
                currentShippingCost = initialShippingCost;
                shippingText = `+ ${currentShippingCost.toFixed(2)} € (Est.)`;
                
                // Ocultar mensaje de recogida, mostrar detalles de dirección, hacer campos de dirección requeridos
                pickupDetailsMessage.classList.add('hidden');
                shippingDetailsStandard.classList.remove('hidden');

                addressStreetInput.required = true;
                addressCityInput.required = true;
                addressZipInput.required = true;
                addressCountryInput.required = true;
                
                // Estilo para el coste de envío
                shippingCostDisplay.classList.remove('text-[#6a760c]', 'font-bold');
                shippingCostDisplay.classList.add('text-[#bf7149]');
            }

            // Actualizar la línea de gastos de envío
            shippingCostDisplay.innerHTML = shippingText;

            // Calcular y actualizar el total a pagar
            const newTotal = subtotal + currentShippingCost;
            totalValueDisplay.textContent = `${newTotal.toFixed(2)} €`;
        }

        // Event Listeners para Tipo de Pago
        gatewayRadio.addEventListener('change', togglePaymentDetails);
        cashRadio.addEventListener('change', togglePaymentDetails);
        
        // Event Listeners para Tipo de Envío
        shippingStandardRadio.addEventListener('change', updateShippingCostAndAddress);
        shippingPickupRadio.addEventListener('change', updateShippingCostAndAddress);

        // Ejecutar al cargar la página para establecer el estado inicial
        togglePaymentDetails();
        updateShippingCostAndAddress();
    });
</script>
{% endblock content %}